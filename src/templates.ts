export function renderUserMd(params: { name?: string; timezone?: string | null }) {
  return `# USER\n\nName: ${params.name ?? "(unknown)"}\nTimezone: ${params.timezone ?? "(unknown)"}\n\n## Preferences\n- Draft external comms\n- PRs only\n`;
}

export function renderGoalsMd(params?: { goals?: string[] }) {
  const goals = params?.goals?.length ? params.goals : ["(add your goals here)"];
  return `# GOALS\n\n${goals.map((g) => `- ${g}`).join("\n")}\n`;
}

export function renderMemoryMd(params?: { seed?: string | null }) {
  return `# MEMORY\n\n${params?.seed ? params.seed : "(autogenerated seed)"}\n`;
}

export function slugify(input: string) {
  return (input || "")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "")
    .slice(0, 64) || "project";
}

export function renderProjectMd(p: any) {
  return `# PROJECT\n\nName: ${p.name || "(unnamed)"}\nStatus: ${p.status || "active"}\n\n## Goal\n${p.goal_title || ""}\n\n${p.goal_description || ""}\n`;
}

export function renderTasksMd(params: { tasks: any[] }) {
  const tasks = params.tasks || [];
  const byStatus = (s: string) => tasks.filter((t) => t.status === s);

  const renderLine = (t: any) => {
    const checked = String(t.status || "").toLowerCase() === "done";
    return `- [${checked ? "x" : " "}] ${t.title || "(untitled)"}  (id:${t.id})`;
  };

  const section = (title: string, items: any[]) => {
    if (!items.length) return `## ${title}\n\n- (none)\n`;
    return `## ${title}\n\n${items.map(renderLine).join("\n")}\n`;
  };

  return [
    "# TASKS\n",
    section("Blocked", byStatus("blocked")),
    section("Needs Review", byStatus("review")),
    section("In Progress", byStatus("in_progress")),
    section("Queued", byStatus("queued")),
    section("Backlog", byStatus("pending")),
    section("Done", byStatus("done")),
  ].join("\n");
}

export function renderJobsMd(params: { jobs: any[] }) {
  const jobs = params.jobs || [];
  const lines = jobs.map((j) => {
    const name = j.name || j.id || "(unnamed)";
    const cron = j.cron_expression || j.cron || "";
    const tz = j.timezone || j.tz || "";
    const on = j.enabled !== false;
    return `- ${name}: ${cron}${tz ? ` (${tz})` : ""} ${on ? "ON" : "OFF"}`;
  });
  return `# JOBS\n\n${lines.length ? lines.join("\n") : "- (none)"}\n`;
}

export function renderHeartbeatsMd(params: { heartbeats: any[] }) {
  const heartbeats = params.heartbeats || [];

  const renderLine = (h: any) => {
    const every = h.interval_minutes ?? h.intervalMinutes ?? h.every_minutes ?? h.everyMinutes;
    const cadence = every ? `every ${every}m` : h.cron_expression ? `cron ${h.cron_expression}` : "(interval unknown)";
    const enabled = h.enabled === false ? "OFF" : "ON";
    const name = h.name || h.id || "(unnamed)";
    return `- ${name}: ${cadence} ${enabled}`;
  };

  return [
    "# HEARTBEATS\n",
    "Heartbeats are *approximate* periodic check-ins (not exact cron).\n",
    heartbeats.length ? heartbeats.map(renderLine).join("\n") : "- (none)",
    "",
  ].join("\n");
}
